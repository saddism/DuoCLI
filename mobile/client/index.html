<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#1a1a2e">
  <title>DuoCLI</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="stylesheet" href="xterm.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- 登录页 -->
  <div id="login-page" class="page active">
    <div class="login-box">
      <h1>🖥 DuoCLI</h1>
      <p>远程终端控制</p>
      <div id="server-info" class="server-info"></div>
      <input type="password" id="token-input" placeholder="输入 Token" autocomplete="off">
      <button id="login-btn">连接</button>
      <div id="login-error" class="error"></div>
    </div>
  </div>

  <!-- 主页面 -->
  <div id="main-page" class="page">
    <header id="header">
      <div class="header-left">
        <h2>DuoCLI</h2>
      </div>
      <div class="header-right">
        <button id="device-console-btn" class="icon-btn" title="手机设备">📱</button>
        <button id="new-session-btn" class="icon-btn" title="新建会话">＋</button>
      </div>
    </header>
    <div id="session-list" class="session-list"></div>
    <div id="empty-state" class="empty-state">
      <p>暂无会话</p>
      <p>点击右上角 ＋ 创建新终端</p>
    </div>
  </div>

  <!-- 会话详情页 -->
  <div id="detail-page" class="page">
    <header id="detail-header">
      <button id="back-btn" class="icon-btn">←</button>
      <div class="detail-title">
        <span id="detail-name"></span>
        <span id="detail-status" class="status-dot"></span>
      </div>
      <span id="detail-ac-label" class="ac-label">催</span>
      <button id="delete-btn" class="icon-btn danger" title="终止会话">✕</button>
    </header>

    <!-- xterm.js 终端 -->
    <div id="terminal-container">
      <div id="terminal-loading" class="terminal-loading">
        <div class="loading-spinner"></div>
        <span>终端连接中…</span>
      </div>
    </div>

    <!-- 快捷键栏 -->
    <div id="shortcut-bar">
      <button class="key-btn" data-key="\x1b">Esc</button>
      <button class="key-btn" data-key="\x1b[A">↑</button>
      <button class="key-btn" data-key="\x1b[B">↓</button>
      <button class="key-btn" data-key="\x1b[D">←</button>
      <button class="key-btn" data-key="\x1b[C">→</button>
      <button class="key-btn" data-key="\x7f">⌫</button>
      <button class="key-btn" data-key="\r">↵</button>
      <button class="key-btn" data-key="\x09">Tab</button>
      <button class="key-btn" data-key="\x03">^C</button>
      <button class="key-btn" data-key="y\r">Y</button>
    </div>

    <!-- 输入区域 -->
    <div id="input-area">
      <input type="file" id="file-input" accept="image/*,*/*" multiple hidden>
      <button id="upload-btn" class="icon-btn-sm" title="上传文件">📎</button>
      <textarea id="msg-input" rows="1" placeholder="输入消息..." enterkeyhint="send" autocomplete="off"></textarea>
      <button id="send-btn">发送</button>
    </div>
  </div>

  <!-- 新建会话弹窗 -->
  <div id="new-session-modal" class="modal">
    <div class="modal-content">
      <h3>新建会话</h3>
      <label>工作目录</label>
      <select id="new-cwd">
        <option value="">~ (默认)</option>
      </select>
      <label>预设命令</label>
      <select id="new-preset">
        <option value="">纯终端 (shell)</option>
        <option value="claude" selected>Claude Code</option>
        <option value="claude --dangerously-skip-permissions">Claude 全自动</option>
        <option value="codex">Codex</option>
        <option value="codex -c sandbox_mode=&quot;danger-full-access&quot; -c approval=&quot;never&quot; -c network=&quot;enabled&quot;">Codex 全自动</option>
        <option value="gemini">Gemini</option>
        <option value="gemini --yolo">Gemini 全自动</option>
        <option value="kimi">Kimi</option>
        <option value="kimi --yolo">Kimi 全自动</option>
      </select>
      <div class="modal-actions">
        <button id="modal-cancel" class="btn-secondary">取消</button>
        <button id="modal-create" class="btn-primary">创建</button>
      </div>
    </div>
  </div>

  <!-- 催工配置弹窗 -->
  <div id="auto-continue-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>催工配置</h3>
        <button id="ac-cancel" class="modal-close">✕</button>
      </div>
      <label>自动发送的内容</label>
      <input type="text" id="ac-message" placeholder="请输入自动发送的内容" />
      <label>间隔时间（分钟）</label>
      <input type="number" id="ac-interval" min="1" placeholder="分钟" />
      <div style="margin-top: 14px;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin: 0;">
          <input type="checkbox" id="ac-auto-agree" checked style="width: auto;" />
          开启自动同意（权限提示自动确认）
        </label>
      </div>
      <div id="ac-agree-delay-row">
        <label>自动同意延后时间（秒）</label>
        <input type="number" id="ac-agree-delay" min="0" value="5" placeholder="秒" />
      </div>
      <div class="modal-actions">
        <button id="ac-stop" class="btn-danger" style="display:none;">关闭催工</button>
        <button id="ac-save" class="btn-primary">保存并开启</button>
      </div>
    </div>
  </div>

  <!-- 设备页 -->
  <div id="device-page" class="page">
    <header>
      <button id="device-back-btn" class="icon-btn">←</button>
      <select id="device-select" class="device-select-header">
        <option value="">正在加载设备...</option>
      </select>
      <button id="device-refresh-btn" class="icon-btn" title="刷新设备列表">🔄</button>
      <button id="device-shot-btn" class="icon-btn" title="刷新截图">📷</button>
      <button id="device-fullscreen-btn" class="icon-btn" title="全屏">⛶</button>
      <button id="device-shell-btn" class="icon-btn" title="执行命令">⌨️</button>
      <button id="device-tap-toggle" class="icon-btn" title="远程点击" style="opacity:0.4;">🖱</button>
    </header>
    <div class="device-page-body">
      <div class="device-preview-wrap">
        <img id="device-preview" alt="设备截图" style="display:none;max-width:100%;max-height:100%;object-fit:contain;" />
        <div id="device-preview-empty" class="device-preview-empty">点击 📷 获取手机截图</div>
      </div>
    </div>
  </div>

  <!-- 全屏截图 overlay -->
  <div id="fullscreen-overlay" style="display:none;position:fixed;inset:0;z-index:200;background:#000;flex-direction:column;">
    <button id="fullscreen-back-btn" style="position:absolute;top:calc(12px + env(safe-area-inset-top,0px));left:12px;z-index:201;width:40px;height:40px;border:none;border-radius:10px;background:rgba(0,0,0,0.5);color:#fff;font-size:20px;cursor:pointer;">←</button>
    <button id="fullscreen-text-btn" style="position:absolute;bottom:calc(12px + env(safe-area-inset-bottom,0px));right:12px;z-index:201;width:44px;height:44px;border:none;border-radius:50%;background:rgba(0,0,0,0.5);color:#fff;font-size:22px;cursor:pointer;">⌨️</button>
    <div style="position:absolute;top:calc(12px + env(safe-area-inset-top,0px));right:12px;z-index:201;display:flex;align-items:center;gap:6px;">
      <select id="fullscreen-interval" style="padding:4px 8px;border-radius:8px;border:none;background:rgba(0,0,0,0.5);color:#fff;font-size:13px;outline:none;">
        <option value="3">3秒</option>
        <option value="5" selected>5秒</option>
        <option value="10">10秒</option>
        <option value="30">30秒</option>
      </select>
      <button id="fullscreen-auto-btn" style="padding:4px 10px;border:none;border-radius:8px;background:rgba(0,0,0,0.5);color:#fff;font-size:13px;cursor:pointer;">自动刷新</button>
    </div>
    <img id="fullscreen-preview" style="width:100%;height:100%;object-fit:contain;" />
  </div>

  <!-- Shell 命令弹窗 -->
  <div id="shell-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>执行命令</h3>
        <button id="shell-modal-close" class="modal-close">✕</button>
      </div>
      <input type="text" id="shell-input" placeholder="输入 adb shell 命令，如 pm list packages" autocomplete="off" />
      <div class="modal-actions">
        <button id="shell-run-btn" class="btn-primary">执行</button>
      </div>
      <pre id="shell-output" style="margin-top:14px;max-height:200px;overflow:auto;background:#111426;color:#cfd7ff;padding:10px;border-radius:10px;font-size:12px;white-space:pre-wrap;word-break:break-word;display:none;"></pre>
    </div>
  </div>

  <!-- 输入文字弹窗 -->
  <div id="input-text-modal" class="modal" style="z-index:300;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>输入文字到手机</h3>
        <button id="input-text-close" class="modal-close">✕</button>
      </div>
      <input type="text" id="fullscreen-text-input" placeholder="输入文字..." autocomplete="off" />
      <div class="modal-actions">
        <button id="fullscreen-text-send" class="btn-primary">发送</button>
      </div>
    </div>
  </div>
  <script src="addon-fit.js"></script>
  <script src="app.js"></script>
</body>
</html>
